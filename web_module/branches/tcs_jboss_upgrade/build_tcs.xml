<project name="topcoder_software" default="compile" basedir=".">

    <!--
        ***********************************************************************************
        This build file is for building and deploying the topcoder software website.  It
        is not for executing tests or running utilities etc.
        ***********************************************************************************
        build ejbs
        deploy (this deploys or and dde expanded, as well as copying over the ejbs and libs)
    -->

    <property name="build.dir" value="build"/>
    <property name="war.dir" value="${build.dir}/wars"/>
    <property name="ear.dir" value="${build.dir}/ears"/>
    <property name="sar.dir" value="${build.dir}/sars"/>
    <property name="ejb.jars.dir" value="${build.dir}/ejb_jars"/>
    <property name="classes.dir" value="${build.dir}/classes"/>
    <property name="lib.dir" value="lib"/>
    <property name="jars.dir" value="${lib.dir}/jars"/>
    <property name="resources.dir" value="resources"/>
    <property name="web.dir" value="web"/>
    <property name="src.dir" value="src"/>
    <property name="bin.dir" value="${lib.dir}/bin"/>
    <property name="java.dir" value="${src.dir}/main"/>
    <property name="shared.src.dir" value="../shared/src/main"/>
    <property name="shared.jar" value="${bin.dir}/shared.jar"/>
    <property name="struts.lib.dir" value="${lib.dir}/jakarta-struts-1.1/lib"/>


    <property environment="env"/>
    <property name="jboss.home.dir" value="${env.JBOSS_HOME}"/>
    <property name="jboss.deploy.dir" value="${jboss.home.dir}/server/default/deploy"/>
    <property name="jboss.lib.dir" value="${jboss.home.dir}/server/default/lib"/>
    <property name="jboss.conf.dir" value="${jboss.home.dir}/server/default/conf"/>

    <property name="deprecation" value="false"/>
    <property name="debug" value="true"/>

    <path id="class.path">
        <pathelement location="${jars.dir}/jboss/javax.servlet.jar"/>
        <pathelement location="${jars.dir}/jboss/javax.servlet.jsp.jar"/>
        <pathelement location="${jars.dir}/jboss/jbossall-client.jar"/>
        <pathelement location="${jars.dir}/jboss/xalan.jar"/>
        <pathelement location="${jars.dir}/jboss/xercesImpl.jar"/>
        <pathelement location="${jars.dir}/jboss/xml-apis.jar"/>
        <pathelement location="${jars.dir}/jboss/mail.jar"/>
        <pathelement location="${jars.dir}/jboss/jboss-system.jar"/>
        <pathelement location="${jars.dir}/log4j-1.2.7.jar"/>
        <pathelement location="${jars.dir}/ifxjdbc.jar"/>
        <pathelement location="${struts.lib.dir}/struts.jar"/>

        <!-- tcs components -->
        <pathelement location="${jars.dir}/tcs/base_exception.jar"/>
        <pathelement location="${jars.dir}/tcs/configuration_manager/2.1.3/configuration_manager.jar"/>
        <pathelement location="${jars.dir}/tcs/document_generation.jar"/>
        <pathelement location="${jars.dir}/tcs/email_engine.jar"/>
        <pathelement location="${jars.dir}/tcs/file_class/1.0/fail_class.jar"/>
        <pathelement location="${jars.dir}/tcs/file_upload.jar"/>
        <pathelement location="${jars.dir}/tcs/forum.jar"/>
        <pathelement location="${jars.dir}/tcs/job_scheduling.jar"/>
        <pathelement location="${jars.dir}/tcs/logging_wrapper.jar"/>
        <pathelement location="${jars.dir}/tcs/math_matrix.jar"/>
        <pathelement location="${jars.dir}/tcs/object_formatter.jar"/>
        <pathelement location="${jars.dir}/tcs/project_phases/1.0/project_phases.jar"/>
        <pathelement location="${jars.dir}/tcs/refreshable_cache.jar"/>
        <pathelement location="${jars.dir}/tcs/searchengine.jar"/>
        <pathelement location="${jars.dir}/tcs/simple_cache.jar"/>
        <pathelement location="${jars.dir}/tcs/tcsUtil.jar"/>
        <pathelement location="${jars.dir}/tcs/typesafe_enum/1.0/typesafe_enum.jar"/>
        <pathelement location="${jars.dir}/tcs/workdays/1.0/workdays.jar"/>
    </path>

    <target name="init">
        <mkdir dir="${classes.dir}"/>
        <mkdir dir="${ejb.jars.dir}"/>
        <mkdir dir="${ear.dir}"/>
        <mkdir dir="${bin.dir}"/>
        <mkdir dir="${sar.dir}"/>
        <mkdir dir="${war.dir}"/>
    </target>

    <target name="compile_shared" depends="init">
        <javac
            srcdir="${shared.src.dir}"
            destdir="${classes.dir}"
            classpathref="class.path"
            deprecation="${deprecation}"
            debug="${debug}"
            >
        </javac>
        <rmic classname="com.topcoder.shared.distCache.CacheClientImpl" base="${classes.dir}"/>
        <rmic classname="com.topcoder.shared.distCache.CacheServerSyncImpl" base="${classes.dir}"/>
    </target>

    <target name="jar_shared" depends="compile_shared">
        <jar jarfile="${shared.jar}">
            <fileset dir="${classes.dir}">
                <include name="com/topcoder/shared/**/*.class"/>
            </fileset>
        </jar>
    </target>

    <target name="compile" depends="init,jar_shared">
        <available property="jdk1.4+" classname="java.nio.ByteBuffer"/>
        <javac
            srcdir="${java.dir}"
            destdir="${classes.dir}"
            classpathref="class.path"
            deprecation="${deprecation}"
            debug="${debug}"
            >
            <include name="com/topcoder/apps/**"/>
            <include name="com/topcoder/dde/**"/>
            <include name="com/topcoder/project/**"/>
            <include name="com/topcoder/sql/**"/>
            <include name="com/topcoder/util/**"/>
        </javac>
    </target>

    <target name="war-or" depends="compile">
        <war warfile="${war.dir}/or.war" webxml="${resources.dir}/or/web.xml">
            <fileset dir="${web.dir}/online_review"/>
            <classes dir="${classes.dir}">
                <include name="com/topcoder/apps/review/cacherefresher/**/*"/>
                <include name="com/topcoder/apps/review/autopilottimer/**/*"/>
                <include name="com/topcoder/apps/review/security/**/*"/>
                <include name="com/topcoder/apps/review/*"/>
                <include name="com/topcoder/dde/util/ApplicationServer.class"/>
                <include name="com/topcoder/dde/util/Cookies.class"/>
            </classes>

            <webinf dir="${struts.lib.dir}">
                <include name="struts.tld"/>
                <include name="struts-bean.tld"/>
                <include name="struts-html.tld"/>
                <include name="struts-logic.tld"/>
                <include name="struts-template.tld"/>
            </webinf>
            <webinf dir="${resources.dir}/or">
                <include name="struts-config.xml"/>
                <include name="jboss-web.xml"/>
            </webinf>
            <webinf dir="${resources.dir}/taglib">
                <include name="review.tld"/>
            </webinf>
        </war>
    </target>

    <target name="war-dde" depends="compile">
        <war warfile="${war.dir}/dde.war" webxml="${resources.dir}/dde/web.xml">
            <fileset dir="${web.dir}/dde"/>
            <classes dir="${classes.dir}">
                <include name="com/topcoder/dde/servlet/**"/>
                <include name="com/topcoder/dde/request/**"/>
                <include name="com/topcoder/dde/util/**"/>
                <include name="com/topcoder/web/common/**/*.class"/>
            </classes>
            <webinf dir="${resources.dir}/taglib">
                <include name="dde.tld"/>
            </webinf>
        </war>
    </target>

    <target name="build-ejbs" depends="compile">

        <jar jarfile="${ejb.jars.dir}/admin.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/admin/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/admin" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/catalog.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/catalog/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/catalog" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/ddeforum.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/forum/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/forum" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/ddePersistenceLayer.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/persistencelayer/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/persistencelayer" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/ddesubmission.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/submission/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/submission" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/notification.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/notification/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/notification" includes="*.xml"/>
        </jar>

        <jar jarfile="${ejb.jars.dir}/persistence.jar" basedir="${classes.dir}" includes="com/topcoder/apps/review/projecttracker/**,
        		com/topcoder/apps/review/document/**,
        		com/topcoder/apps/review/ConcurrentModificationException.class,
        		com/topcoder/apps/review/GeneralSecurityException.class,
        		com/topcoder/apps/review/IncorrectProjectStateException.class,
        		com/topcoder/apps/review/persistence/**,
        		com/topcoder/apps/review/security/*Permission.class">
            <metainf dir="${java.dir}/com/topcoder/apps/review/projecttracker" includes="*.xml"/>
        </jar>


        <jar jarfile="${ejb.jars.dir}/user.jar">
            <zipfileset dir="${classes.dir}" includes="com/topcoder/util/TCException.class"/>
            <zipfileset dir="${classes.dir}" includes="com/topcoder/util/DDEException.class"/>
            <zipfileset dir="${classes.dir}" includes="com/topcoder/util/Constants.class"/>
            <zipfileset dir="${classes.dir}" includes="com/topcoder/util/ConstantsInt.class"/>
            <zipfileset dir="${classes.dir}" includes="com/topcoder/dde/user/**"/>
            <metainf dir="${java.dir}/com/topcoder/dde/user" includes="*.xml"/>
        </jar>

    </target>

    <target name="build-sars" depends="compile">
        <jar jarfile="${sar.dir}/cache_refresher.sar" basedir="${classes.dir}" includes="com/topcoder/apps/review/cacherefresher/**">
            <metainf dir="${java.dir}/com/topcoder/apps/review/cacherefresher" includes="*.xml"/>
        </jar>

        <jar jarfile="${sar.dir}/auto_pilot_timer.sar" basedir="${classes.dir}" includes="com/topcoder/apps/review/autopilottimer/**,
                        com/topcoder/apps/review/document/**,
                        com/topcoder/apps/review/*,
                        com/topcoder/apps/review/projecttracker/**">
            <metainf dir="${java.dir}/com/topcoder/apps/review/autopilottimer" includes="*.xml"/>
        </jar>

    </target>

    <target name="copy-libs">
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs">
                <include name="base_exception.jar"/>
                <include name="document_generation.jar"/>
                <include name="email_engine.jar"/>
                <include name="file_upload.jar"/>
                <include name="forum.jar"/>
                <include name="job_scheduling.jar"/>
                <include name="logging_wrapper.jar"/>
                <include name="math_matrix.jar"/>
                <include name="object_formatter.jar"/>
                <include name="refreshable_cache.jar"/>
                <include name="searchengine.jar"/>
                <include name="simple_cache.jar"/>
                <include name="tcsUtil.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}">
                <include name="security.jar"/>
                <include name="upload.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs/typesafe_enum/1.0">
                <include name="typesafe_enum.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs/configuration_manager/2.1.3">
                <include name="configuration_manager.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs/project_phases/1.0">
                <include name="project_phases.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs/workdays/1.0">
                <include name="workdays.jar"/>
            </fileset>
        </copy>
        <copy todir="${jboss.lib.dir}">
            <fileset dir="${jars.dir}/tcs/fail_class/1.0">
                <include name="fail_class.jar"/>
            </fileset>
        </copy>
    </target>

    <target name="deploy" depends="war-dde,war-or,build-ejbs,build-sars,copy-libs">

        <ear earfile="${ear.dir}/dde.ear" appxml="${resources.dir}/dde/application.xml">
            <fileset dir="${sar.dir}">
                <include name="*.sar"/>
            </fileset>
            <fileset dir="${ejb.jars.dir}">
                <include name="*.jar"/>
            </fileset>
            <fileset dir="${jars.dir}/tcs">
                <include name="idgenerator.jar"/>
            </fileset>
        </ear>

        <mkdir dir="${jboss.deploy.dir}/dde.ear"/>
        <unjar src="${ear.dir}/dde.ear" dest="${jboss.deploy.dir}/dde.ear" overwrite="yes"/>

        <unwar src="${war.dir}/dde.war" dest="${jboss.deploy.dir}/dde.ear/dde.war/" overwrite="yes"/>
        <delete dir="${jboss.deploy.dir}/dde.ear/dde.war/META-INF"/>

        <unwar src="${war.dir}/or.war" dest="${jboss.deploy.dir}/dde.ear/or.war/" overwrite="yes"/>
        <delete dir="${jboss.deploy.dir}/dde.ear/or.war/META-INF"/>

    </target>

</project>

