<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
  <head>
    <title></title>
  </head>
  <body>
        <form name=frmTesting>
        <table border=0 width="100%">
            <tr>
                <td>
                    <span id=countSpan></span>
                </td>
            </tr>
            <tr>
                <td>
                    <select multiple=multiple id=listBox size=5 style="width:96%">
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <input type=text id="inputText" style="width:96%" />
                </td>
            </tr>
            <tr>
                <td align=center>
                    <input type=button id="moveUpButton" value="^" onclick="moveUp();" />
                    <input type=button id="moveDownButton" value="V" onclick="moveDown();"/>
                    <input type=button id="addSingleButton" value="+" onclick="addSingle();" />
                    <input type=button id="addPlusPlusButton" value="++" onclick="addPlusPlus();" />
                    <input type=button id="deleteButton" value="-" onclick="doDelete();"/>
                    <input type=button id="addBracketsButton" value="{}" onclick="addBrackets();" />
                    <input type=button id="clearButton" value="C" onclick="clearList();" />
                </td>
            </tr>
            <tr>
                <td>
                    &nbsp;
                </td>
            </tr>
            <tr>
                <td align=center>
                    <input type=button id="okButton" value="OK" onclick="ok();" />
                    <input type=button id="cancelButton" value="Cancel" onclick="cancel();"/>
                    
                </td>
            </tr>
        </table>
        <!-- this will be dynamically written out by the backend for this page -->
        <script language="javascript">
            var arg = 0;
            var argType = "";
            var displayArgType = "";

            //load arg / arg type
            arg = getValue("window.opener.document.frmTesting", "arrayArg");
            argType = getValue("window.opener.document.frmTesting", "arrayArgType");
            displayArgType = getValue("window.opener.document.frmTesting", "arrayDisplayArgType");
            
            //load data
            var tmpVal = getValue("window.opener.opener.document.forms[0]", "arg" + arg);
            document.frmTesting.inputText.value = tmpVal;
            addBrackets();
            
            //updateCountSpan();
            
            function ok() {
                //build string from array
                var arr = "";
                
                for(var i = 0; i < getLength("document.frmTesting", "listBox.options") ; i++) {
                    var val = getOption("document.frmTesting", "listBox", i).value;
                    alert(getOption("document.frmTesting", "listBox", i));
                    val = replace(val, "\\", "\\\\");
                    val = replace(val, "\"", "\\\"");
                    arr = arr + "\"" + val + "\",";
                }
                
                arr = arr.substring(0, arr.length-1);
                alert(arr);
                
                putValue("window.opener.opener.document.forms[0]", "arg" + arg, arr);
                putValue("window.opener.document.forms[0]", "arg" + arg + "input", "modify");
                
                window.close();
                window.opener.focus();
            }
            
            function replace(string,text,by) {
                var strLength = string.length, txtLength = text.length;
                if ((strLength == 0) || (txtLength == 0)) return string;

                var i = string.indexOf(text);
                if ((!i) && (text != string.substring(0,txtLength))) return string;
                if (i == -1) return string;

                var newstr = string.substring(0,i) + by;

                if (i+txtLength < strLength)
                    newstr += replace(string.substring(i+txtLength,strLength),text,by);

                return newstr;
            }
            
            function cancel() {
                window.close();
                window.opener.focus();
            }
            
            function addBrackets() {
                var val = getValue("document.frmTesting", "inputText");
                val = trim(val);

                if (val.length > 0 && val.charAt(0) == '{') val = val.substr(1);
                if (val.length > 0 && val.charAt(val.length - 1) == '}') val = val.substring(0, val.length - 1);
                
                if(val.length != 0)
                {
                    var state = "S";
                    var ignored = false;
                    var buf = "";
                    
                    for (var i = 0; i < val.length; i++) {
                        var ch = val.charAt(i);
                        switch (state) {
                        case "E":
                            switch (ch) {
                            case '\\':
                                buf = buf + '\\';
                                break;
                            case '"':
                                buf = buf + '"';
                                break;
                            default: 
                                buf = buf + '\\';
                                buf = buf + ch;
                            }
                            state = "I";
                            break;
                        case "I":
                            switch (ch) {
                            case '\\':
                                state = "E";
                                break;
                            case '"':
                                state = "S";

                                if (buf.length > 50) {
                                    ignored = true;
                                    continue;
                                }
                     
                                if(validateArg(buf)) {
                                    //valid, now add
                                    putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(buf));
                                } else {
                                    return;
                                }
                                
                                buf = "";
                                break;
                            default:
                                buf = buf + ch;
                                break;
                            }
                            break;
                        case "S":
                            if (trim(ch) == "") {
                                if (buf.length > 0) {
                                    
                                    if (buf.length > 50) {
                                        ignored = true;
                                        continue;
                                    }
                                    if(validateArg(buf)) {
                                        //valid, now add
                                        putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(buf));
                                    } else {
                                        return;
                                    }
                                    
                                    buf = "";
                                }
                                continue;
                            }
                            switch (ch) {
                            case '"':
                                if (buf.length > 0) {
                                    buf = buf + '"';
                                } else {
                                    state = "I";
                                }
                                break;
                            case ',':
                                if (buf.length > 0 || (i == 0) || (i > 0 && val.charAt(i - 1) == ',')) {
                                    
                                    if (buf.length() > 50) {
                                        ignored = true;
                                        continue;
                                    }
                                    if(validateArg(buf)) {
                                        //valid, now add
                                        putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(buf));
                                    } else {
                                        return;
                                    }
                                    
                                    buf = "";
                                }
                                break;
                            default:
                                buf = buf + ch;
                            }
                        }
                    }
                    if (buf.length > 0 || val.charAt(val.length - 1) == ',') {
                        buf = trim(buf);
                        if (buf.length > 50) {
                            ignored = true;
                        } else {
                            if(validateArg(buf)) {
                                //valid, now add
                                putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(buf));
                            } else {
                                return;
                            }
                        }
                        
                        buf = "";
                    }
                    if (ignored) {
                        alert("One or more entries were ignored because they were either empty (blank) or had a size greater than 50..");
                    } 
                }
                
                clearInput();
                updateCountSpan();
            }
            
            function trim(sString)
            {
                    return trimLeading(trimTrailing(sString));
            }
            function trimLeading(sString)
            {
                    if(sString && sString != "") 
                    {
                            var strchar = sString.charAt(0);
                            while(strchar == ' ')
                            {
                                    sString = sString.substr(1);
                                    strchar = sString.charAt(0);
                            }
                    }
                            return sString;
            }
            function trimTrailing(sString)
            {
                    if(sString && sString != "") 
                    {
                            var strchar = sString.charAt(sString.length - 1);
                            while(strchar == ' ')
                            {
                                    sString = sString.substr(0,sString.length - 1);
                                    strchar = sString.charAt(sString.length - 1);
                            }
                    }
                    return sString;
            }
            
            function addPlusPlus() {
                var val = getValue("document.frmTesting", "inputText").split(",");
                for(var i = 0; i < val.length; i++) {
                    if(validateArg(val[i])) {
                        //valid, now add
                        putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(val[i]));
                    } else {
                        return;
                    }
                }
                
                clearInput();
                updateCountSpan();
                
            }
            
            function moveDown() {
                //special case: if index n is selected, must wait for break
                var foundBreak = true;
                for(var i = getLength("document.frmTesting", "listBox.options") - 1; i >= 0; i--) {
                    if(getSelected("document.frmTesting", "listBox", i)) {
                        if(i == (getLength("document.frmTesting", "listBox.options")-1)) {
                            //special case, look for break;
                            foundBreak = false;
                        } else {
                            if(foundBreak) {
                                //move up
                                var temp = getOption("document.frmTesting", "listBox", i+1).value;
                                var tempSelected = getOption("document.frmTesting", "listBox", i+1).selected;
                                
                                var newVal = getOption("document.frmTesting", "listBox", i).value;
                                var newSelected = getOption("document.frmTesting", "listBox", i).selected;

                                putOption("document.frmTesting", "listBox", i+1, new Option(newVal, newVal, newSelected));
                                putOption("document.frmTesting", "listBox", i, new Option(temp, temp, tempSelected));
                            }
                        }
                    } else {
                        foundBreak = true;
                    }
                }
                
            }
            
            function moveUp() {
                //special case: if index 0 is selected, must wait for break
                var foundBreak = true;
                for(var i = 0; i < getLength("document.frmTesting", "listBox.options"); i++) {
                    if(getSelected("document.frmTesting", "listBox", i)) {
                        if(i == 0) {
                            //special case, look for break;
                            foundBreak = false;
                        } else {
                            if(foundBreak) {
                                //move up
                                var temp = getOption("document.frmTesting", "listBox", i-1).value;
                                var tempSelected = getOption("document.frmTesting", "listBox", i-1).selected;
                                
                                var newVal = getOption("document.frmTesting", "listBox", i).value;
                                var newSelected = getOption("document.frmTesting", "listBox", i).selected;

                                putOption("document.frmTesting", "listBox", i-1, new Option(newVal, newVal, newSelected));
                                putOption("document.frmTesting", "listBox", i, new Option(temp, temp, tempSelected));
                            }
                        }
                    } else {
                        foundBreak = true;
                    }
                }
                
            }
            
            function doDelete() {
                var i = 0;
                while(i < getLength("document.frmTesting", "listBox.options")) {
                    if(getSelected("document.frmTesting", "listBox", i)) {
                        putOption("document.frmTesting", "listBox", i, null);
                    } else {
                        i++;
                    }
                }
                
                updateCountSpan();
            }
            
            function clearList() {
                for(var i = getLength("document.frmTesting", "listBox.options") -1 ; i >= 0; i--) {
                    putOption("document.frmTesting", "listBox", i, null);
                }
                clearInput();
                updateCountSpan();
            }
            
            function addSingle() {
                var val = getValue("document.frmTesting", "inputText");
                if(validateArg(val)) {
                    //valid, now add
                    putOption("document.frmTesting", "listBox", getLength("document.frmTesting", "listBox.options"), new Option(val));
                    
                    clearInput();
                    updateCountSpan();
                }
            }
            
            function clearInput() {
                putValue("document.frmTesting", "inputText", "");
            }
            
            function validateArg(val) {
                switch(argType) {
                    case "String[]":
                        //anything is valid
                        break;
                    case "int[]":
                        alert("TODO");
                        break;
                    default:
                        alert("TODO");
                        break;
                }
                
                return true;
            }
            
            function updateCountSpan() {
                putInnerHTML("document", "countSpan", displayArgType + " -- " + getLength("document.frmTesting", "listBox.options"));
            }
            
            function getSelected(root, name, option) {
                return getAttrib(root, name, "options[" + option + "].selected");
            }
            
            function getLength(root, name) {
                return getAttrib(root, name, "length");
            }
            
            function getOption(root, name, option) {
                return getAttrib(root, name, "options[" + option + "]");
            }
            
            function putOption(root, name, option, value) {
                putAttrib(root, name, "options[" + option + "]", value);
            }
            
            function putValue(root, name, newValue) {
                putAttrib(root, name, "value", newValue);
            }
            
            function putInnerHTML(root, name, newValue) {
                putAttrib(root, name, "innerHTML", newValue);
            }
            
            function putAttrib(root, name, attrib, newValue) {
                if(eval(root + ".getElementById")) {
                    eval(root + ".getElementById('" + name + "')." + attrib + " = newValue;");
                } else if(eval(root + ".all")) {
                    eval(root + ".all." + name + "." + attrib + " = newValue;");
                } else {
                    eval(root + "." + name + "." + attrib + " = newValue;");
                }
            }
            
            function getValue(root, name) {
                return getAttrib(root, name, "value");
            }
            
            function getAttrib(root, name, attribute) {
                if(eval(root + ".getElementById")) {
                    return eval(root + ".getElementById('" + name + "')." + attribute + ";");
                } else if(eval(root + ".all")) {
                    return eval(root + ".all." + name + "." + attribute + ";");
                } else {
                    return eval(root + "." + name + "." + attribute + ";");
                }
            }
            
        </script>
        </form>
  </body>
</html>
