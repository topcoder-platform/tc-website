<!--
    This build script provides targets to assist in the
    moving of code to a production environment
 -->
<project name="topcoder" default="" basedir=".">

    <property name="jboss_home" value="../jboss-4.0.2"/>
    <property name="tempMoveDir" value="move"/>
    <property name="tempDeployDir" value="deploy"/>
    <property name="build" value="build"/>
    <property name="war_dir" value="${build}/wars"/>
    <property name="techassess_war_dir" value="${jboss_home}/server/default/deploy/techassess.war/"/>

    <target name="jar-classes" depends="">
        <jar destfile="./lib/bin/classes.jar" update="true">
            <fileset dir="./build/classes">
                <include name="**"/>
            </fileset>
        </jar>
    </target>

    <target name="package-topcoder" depends="">

        <!--
                <delete dir="src"/>
                <delete dir="resources"/>
                <delete dir="../shared/src"/
        -->
        <delete dir="build"/>
        <delete file="topcoder.jar"/>

        <cvs command="update -Pd" package="src"/>
        <cvs command="update -Pd" package="resources"/>
        <cvs command="update -Pd" package="lib"/>
        <cvs command="update -Pd" package="build_tc.xml"/>

        <exec dir="../shared" executable="cvs">
            <arg line="update -dP src"/>
        </exec>

        <ant antfile="build_tc.xml" target="deploy"/>

        <ant antfile="build_oracle.xml" target="deploy-oracle"/>

        <antcall target="jar-classes"/>

        <jar destfile="topcoder.jar" update="true">
            <fileset dir=".">
                <include name="build/ejb_jars/**"/>
                <include name="build/wars/**"/>
                <include name="build/sars/**"/>
                <include name="build/ears/security.ear"/>
                <include name="resources/xsl/**"/>
                <include name="resources/taglib/**"/>
                <include name="resources/tc/**"/>
                <include name="resources/longcontest/**"/>
                <include name="resources/stat/**"/>
                <include name="resources/corp/**"/>
                <include name="resources/email/**"/>
                <include name="resources/privatelabel/**"/>
                <include name="resources/TC.properties"/>
                <include name="resources/PrivateLabel*.properties"/>
                <include name="resources/PactsInternalServlet.properties"/>
                <include name="resources/Registration.properties"/>
                <include name="resources/LongContest.properties"/>
                <include name="resources/CorpConstants.properties"/>
                <include name="resources/DataAccess.properties"/>
                <include name="resources/problem.xsd"/>
                <include name="move.xml"/>
                <include name="build_tc.xml"/>
                <include name="lib/bin/shared.jar"/>
                <include name="lib/bin/tcwebcommon.jar"/>
                <include name="lib/bin/classes.jar"/>

                <include name="resources/oracle/**"/>
                <include name="resources/Oracle.properties"/>
                <include name="build_oracle.xml"/>

            </fileset>
        </jar>

    </target>

    <target name="package-techassess" depends="">
        <!--
                <delete dir="src"/>
                <delete dir="resources"/>
                <delete dir="build"/>
                <delete dir="../shared/src"/>
                <delete file="techassess.jar"/>

                <cvs command="update -Pd" package="src"/>
                <cvs command="update -Pd" package="resources"/>
                <cvs command="update -Pd" package="lib"/>

                <exec dir="../shared" executable="cvs">
                    <arg line="update -dP src"/>
                </exec>
        -->

        <ant antfile="build.xml" target="war-techassess"/>
        <ant dir="../app" antfile="build.xml" target="screening-ejb-jars"/>

        <mkdir dir="${tempMoveDir}"/>

        <copy todir="${tempMoveDir}" file="build/wars/techassess.war"/>
        <copy todir="${tempMoveDir}" file="lib/bin/shared.jar"/>
        <copy todir="${tempMoveDir}" file="lib/bin/tcwebcommon.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/deploy/reconnect.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/deploy/ProblemServices.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/deploy/ScreeningServices.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/deploy/ScreeningTesterCompilerServices.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/deploy/ScreeningAdminServices.jar"/>
        <copy todir="${tempMoveDir}" file="${jboss_home}/server/default/lib/Screening.jar"/>

        <jar destfile="techassess.jar" update="true">
            <fileset dir="${tempMoveDir}">
                <include name="techassess.war"/>
                <include name="shared.jar"/>
                <include name="tcwebcommon.jar"/>
                <include name="reconnect.jar"/>
                <include name="Screening.jar"/>
                <include name="ProblemServices.jar"/>
                <include name="ScreeningServices.jar"/>
                <include name="ScreeningTesterCompilerServices.jar"/>
                <include name="ScreeningAdminServices.jar"/>
            </fileset>
        </jar>

        <delete dir="${tempMoveDir}"/>
    </target>

    <target name="package-software" depends="">
        <cvs command="update -Pd"/>
        <exec dir="../shared" executable="cvs">
            <arg line="update -dP src"/>
        </exec>
        <ant antfile="build.xml" target="clean"/>
        <ant antfile="build_tcs.xml" target="build-site"/>
        <!--remove with new OR
                <ant antfile="build_tcs.xml" target="build-screening"/>
        -->

        <jar destfile="software.jar" update="true">
            <fileset dir=".">
                <include name="lib/bin/shared.jar"/>
                <include name="lib/bin/tcwebcommon.jar"/>
                <!--remove with new OR
                                <include name="lib/bin/screening.jar"/>
                -->
                <include name="build/ears/dde.ear"/>
                <!--remove with new OR
                                <include name="build/wars/review.war"/>
                -->
                <include name="build/wars/dde.war"/>
                <include name="build/wars/onsite.war"/>
                <include name="build/ejb_jars/Project.jar"/>
                <include name="build/ejb_jars/RBoard.jar"/>
                <!--remove with new OR
                                <include name="build/ejb_jars/Specification.jar"/>
                -->
                <include name="build_tcs.xml"/>
                <include name="resources/automatic_screening/com/topcoder/apps/**"/>
                <include name="resources/automatic_screening/com/topcoder/file/**"/>
                <include name="resources/automatic_screening/com/topcoder/util/**"/>
                <include name="resources/onsite.properties"/>
            </fileset>
        </jar>
    </target>

    <target name="package-forums-full" depends="">
        <antcall target="package-forums"/>
        <ant antfile="build.xml" target="build-security"/>

        <jar destfile="forums.jar" update="true">
            <fileset dir=".">
                <include name="lib/jars/jive/**"/>
                <include name="lib/jars/tcs/file_upload/2.0/file_upload.jar"/>
                <include name="build/ears/security.ear"/>
            </fileset>
        </jar>
    </target>

    <target name="package-forums" depends="">
        <!--
                <delete dir="src"/>
        -->
        <delete dir="build"/>
        <delete dir="../shared/src"/>
        <delete file="forums.jar"/>

        <cvs command="update -Pd" package="src"/>
        <cvs command="update -Pd" package="resources"/>
        <cvs command="update -Pd" package="lib"/>
        <cvs command="update -Pd" package="build.xml"/>

        <exec dir="../shared" executable="cvs">
            <arg line="update -dP src"/>
        </exec>


        <ant antfile="build.xml" target="build-forums"/>

        <!--
                <copy todir="../jboss-4.0.2/server/default/lib">
                    <fileset dir="lib/bin">
                        <include name="shared.jar"/>
                    </fileset>
                </copy>
        -->

        <jar destfile="forums.jar" update="true">
            <fileset dir=".">
                <include name="lib/jars/tcjive.jar"/>
                <include name="build/wars/forums.war"/>
                <include name="build/ejb_jars/messagehistory.jar"/>
                <include name="build/ejb_jars/forums.jar"/>
                <include name="lib/bin/shared.jar"/>
                <include name="lib/bin/tcwebcommon.jar"/>
                <include name="build.xml"/>
            </fileset>
        </jar>
    </target>

    <target name="package-studio" depends="">

        <delete dir="build"/>
        <delete file="studio.jar"/>

        <cvs command="update -Pd" package="src"/>
        <cvs command="update -Pd" package="resources"/>
        <cvs command="update -Pd" package="lib"/>
        <cvs command="update -Pd" package="build_studio.xml"/>

        <exec dir="../shared" executable="cvs">
            <arg line="update -dP src"/>
        </exec>

        <ant antfile="build_studio.xml" target="deploy-studio"/>
        <ant antfile="build_studio.xml" target="build-security"/>

        <jar destfile="studio.jar" update="true">
            <fileset dir=".">
                <include name="build/ejb_jars/*.jar"/>
                <include name="build/wars/*.war"/>
                <include name="build/ears/*.ear"/>
                <include name="resources/studio/**"/>
                <include name="resources/forums/filter/**"/>
                <include name="resources/longcontest/**"/>
                <include name="resources/Studio.properties"/>
                <include name="move.xml"/>
                <include name="build_studio.xml"/>
                <include name="lib/bin/*.jar"/>
            </fileset>
        </jar>

    </target>

    <target name="package-csf" depends="">

        <delete dir="build"/>
        <delete file="csf.jar"/>

        <cvs command="update -Pd" package="src"/>
        <cvs command="update -Pd" package="resources"/>
        <cvs command="update -Pd" package="lib"/>
        <cvs command="update -Pd" package="build_csf.xml"/>

        <exec dir="../shared" executable="cvs">
            <arg line="update -dP src"/>
        </exec>

        <ant antfile="build_csf.xml" target="deploy-csf"/>
        <ant antfile="build_csf.xml" target="build-security"/>

        <jar destfile="csf.jar" update="true">
            <fileset dir=".">
                <include name="build/ejb_jars/*.jar"/>
                <include name="build/wars/*.war"/>
                <include name="build/ears/*.ear"/>
                <include name="resources/csf/**"/>
                <include name="resources/forums/filter/**"/>
                <include name="resources/forums/csf/**"/>
                <include name="resources/CSF.properties"/>
                <include name="move.xml"/>
                <include name="build_csf.xml"/>
                <include name="lib/bin/*.jar"/>
            </fileset>
        </jar>

    </target>


    <target name="deploy-techassess" depends="">
        <!-- create backup -->
        <tstamp/>
        <property name="backupDirectory" value="backup/techassess/${DSTAMP}-${TSTAMP}"/>
        <echo message="Backing up to: ${backupDirectory}"/>
        <mkdir dir="${backupDirectory}"/>

        <copy todir="${backupDirectory}" file="build/wars/techassess.war"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/lib/shared.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/lib/tcwebcommon.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/deploy/reconnect.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/deploy/ProblemServices.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/deploy/ScreeningServices.jar"/>
        <copy todir="${backupDirectory}"
              file="${jboss_home}/server/default/deploy/ScreeningTesterCompilerServices.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/deploy/ScreeningAdminServices.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/lib/Screening.jar"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/conf/ApplicationServer.properties"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/conf/login-config.xml"/>
        <copy todir="${backupDirectory}" file="${jboss_home}/server/default/conf/problem.xsd"/>

        <mkdir dir="${tempDeployDir}"/>
        <unjar src="techassess.jar" dest="${tempDeployDir}"/>
        <copy overwrite="true" todir="${war_dir}" file="${tempDeployDir}/techassess.war"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/lib" file="${tempDeployDir}/shared.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/lib" file="${tempDeployDir}/tcwebcommon.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/deploy" file="${tempDeployDir}/reconnect.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/deploy" file="${tempDeployDir}/ProblemServices.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/deploy"
              file="${tempDeployDir}/ScreeningServices.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/deploy"
              file="${tempDeployDir}/ScreeningTesterCompilerServices.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/deploy"
              file="${tempDeployDir}/ScreeningAdminServices.jar"/>
        <copy overwrite="true" todir="${jboss_home}/server/default/lib" file="${tempDeployDir}/Screening.jar"/>
        <delete dir="${tempDeployDir}"/>

        <delete file="${jboss_home}/server/default/deploy/techassess.war"/>
        <delete dir="${techassess_war_dir}"/>
        <mkdir dir="${techassess_war_dir}"/>
        <unwar src="${war_dir}/techassess.war" dest="${techassess_war_dir}" overwrite="yes"/>
        <delete dir="${techassess_war_dir}/META-INF"/>
    </target>


</project>

