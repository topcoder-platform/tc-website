<project name="topcoder" default="main" basedir=".">
    <property name="Name" value="TopCoder"/>
    <property name="build" value="build"/>
    <property name="war.dir" value="${build}/wars"/>
    <property name="ejb_jars" value="${build}/ejb_jars"/>
    <property name="classes" value="${build}/classes"/>
    <property name="testclasses" value="${build}/testcases"/>
    <property name="build.javadocs" value="${build}/javadocs"/>
    <property name="lib.dir" value="lib"/>
    <property name="jars.dir" value="${lib.dir}/jars"/>
    <property name="bin" value="lib/bin"/>
    <property name="src.dir" value="src"/>
    <property name="java" value="${src.dir}/main"/>
    <property name="shared" value="../shared/src/main"/>
    <property name="testjava" value="${src.dir}/testcases"/>
    <property name="resources" value="resources"/>
    <property name="conf" value="conf"/>
    <property name="taglib" value="${resources}/taglib"/>
    <property name="images" value="images"/>
    <property name="shared.jar" value="${bin}/shared.jar"/>
    <property name="common.jar" value="${bin}/tcwebcommon.jar"/>
    <property name="web" value="src/main/com/topcoder/web"/>
    <property name="jboss_home" value="../jboss-4.2.0.GA"/>
    <property name="jboss_deploy" value="${jboss_home}/server/distui/deploy"/>
    <property name="jboss_lib" value="${jboss_home}/server/distui/lib"/>
    <property name="jboss_conf" value="${jboss_home}/server/distui/conf"/>
    <property environment="env"/>

    <property name="deprecation" value="true"/>
    <property name="debug" value="true"/>
    <property name="junitsummary" value="on"/>

    <target name="main" depends="compile">
    </target>


    <path id="class.path">
        <pathelement location="${classes}"/>
        <pathelement location="${testclasses}"/>
        <pathelement location="${resources}"/>
        <pathelement location="${resources}/hibernate"/>
        <pathelement location="${images}"/>
        <pathelement location="${jars.dir}/log4j-1.2.7.jar"/>
        <pathelement location="${jars.dir}/ifxjdbc.jar"/>
        <pathelement location="${jars.dir}/bfograph.jar"/>
        <pathelement location="${jars.dir}/activation.jar"/>

        <pathelement location="${jars.dir}/jboss/javax.servlet.jar"/>
        <pathelement location="${jars.dir}/jboss/javax.servlet.jsp.jar"/>
        <pathelement location="${jars.dir}/jboss/jbossall-client.jar"/>
        <pathelement location="${jars.dir}/jboss/xalan.jar"/>
        <pathelement location="${jars.dir}/jboss/xercesImpl.jar"/>
        <pathelement location="${jars.dir}/jboss/xml-apis.jar"/>
        <pathelement location="${jars.dir}/jboss/mail.jar"/>
        <pathelement location="${jars.dir}/jboss/jboss-system.jar"/>
        <pathelement location="${jars.dir}/jboss/jboss-cache.jar"/>
        <pathelement location="${jars.dir}/jboss/jgroups.jar"/>

    </path>
    <!-- adding this here because i can't figure out how to use the above path element in other path elements-->
    <property name="class.path" refid="class.path"/>

    <target name="init">
        <mkdir dir="${classes}"/>
        <mkdir dir="${testclasses}"/>
        <mkdir dir="${bin}"/>
        <mkdir dir="${ejb_jars}"/>
        <mkdir dir="${war.dir}"/>
    </target>

    <target name="compile_shared" depends="init" unless="compile_shared_set">
        <javac
                srcdir="${shared}"
                destdir="${classes}"
                classpathref="class.path"
                deprecation="${deprecation}"
                debug="${debug}"
                source="1.5"
                target="1.5"
                >
        </javac>
        <rmic classname="com.topcoder.shared.distCache.CacheClientImpl" base="${classes}"/>
        <rmic classname="com.topcoder.shared.distCache.CacheServerSyncImpl" base="${classes}"/>
        <property name="compile_shared_set" value="true"/>
    </target>

    <target name="compile" depends="init,jar_shared" unless="compile_set">
        <javac
                srcdir="${java}"
                destdir="${classes}"
                classpathref="class.path"
                deprecation="${deprecation}"
                debug="${debug}"
                source="1.5"
                target="1.5" memoryMaximumSize="380m" memoryInitialSize="380m" fork="true">
            <include name="com/topcoder/common/**"/>
            <include name="com/topcoder/ejb/**"/>
            <include name="com/topcoder/security/**"/>
            <include name="com/topcoder/utilities/**"/>
            <include name="com/topcoder/web/distui/**"/>
            <exclude name="com/topcoder/web/csf/**"/>
            <exclude name="com/topcoder/web/wiki/**"/>
            <exclude name="com/topcoder/web/studio/**"/>
            <exclude name="com/topcoder/web/forums/**"/>
            <exclude name="com/topcoder/web/onsite/**"/>
            <exclude name="com/topcoder/web/oracle/**"/>
        </javac>
        <property name="compile_set" value="true"/>
        <antcall target="jar_common"/>
    </target>

    <target name="javadocs">
        <mkdir dir="${build.javadocs}"/>
        <javadoc
                packagenames="com.topcoder.common.*,com.topcoder.ejb.*,com.topcoder.security.*,com.topcoder.utilities.*,com.topcoder.web.*"
                sourcepath="${java}"
                classpathref="class.path"
                destdir="${build.javadocs}"
                windowtitle="${Name} API"
                doctitle="${Name} API"
                maxmemory="256M"
                >
        </javadoc>
    </target>

    <target name="clean">
        <!-- kill the entire build dir -->
        <delete dir="${build}"/>
        <delete dir="${bin}"/>
    </target>

    <target name="jar_shared" depends="compile_shared" unless="jar_shared_set">
        <jar jarfile="${shared.jar}">
            <fileset dir="${classes}">
                <include name="com/topcoder/shared/**/*.class"/>
            </fileset>
        </jar>
        <property name="jar_shared_set" value="true"/>
    </target>

    <target name="jar_common">
        <jar jarfile="${common.jar}">
            <fileset dir="${classes}">
                <include name="com/topcoder/web/common/**/*.class"/>
                <include name="com/topcoder/common/**/*.class"/>
                <exclude name="com/topcoder/web/common/cache/admin/**/*"/>
            </fileset>
        </jar>
    </target>

    <target name="war" depends="compile">
        <war warfile="${war.dir}/distui.war" webxml="${resources}/distui/web.xml">
            <fileset dir="${java}/com/topcoder/web/jsp">
                <include name="errorPage.jsp"/>
                <include name="top.jsp"/>
                <include name="foot.jsp"/>
                <include name="date_time.jsp"/>
                <include name="script.jsp"/>
                <include name="style.jsp"/>
                <include name="body_top.jsp"/>
                <include name="page_title.jsp"/>
                <include name="menu.jsp"/>
                <include name="includes/global_left.jsp"/>
                <include name="includes/modules/simpleSearch.jsp"/>
                <include name="calendar.jsp"/>
                <include name="public_right.jsp"/>
            </fileset>
            <fileset dir="${java}/com/topcoder/web/distui/view">
                <include name="**/*.jsp"/>
            </fileset>
            <classes dir="${classes}">
                <include name="com/topcoder/web/distui/**/*.class"/>
            </classes>
            <webinf dir="${resources}/taglib">
                <include name="nav.tld"/>
            </webinf>
            <webinf dir="${resources}/distui">
                <include name="jboss-web.xml"/>
            </webinf>
            <lib dir="${jars.dir}">
                <include name="jstl.jar"/>
                <include name="standard.jar"/>
                <include name="taconite.jar"/>
            </lib>
            <lib dir="${bin}">
                <include name="shared.jar"/>
                <include name="tcwebcommon.jar"/>
            </lib>
        </war>
        <unwar src="${war.dir}/distui.war" dest="${jboss_deploy}/distui.war/" overwrite="yes"/>
        <delete dir="${jboss_deploy}/distui.war/META-INF"/>
    </target>


    <target name="deploy">
        <antcall target="war"/>
        <antcall target="expand"/>


    </target>

    <target name="expand">
        <copy todir="${jboss_conf}">
            <fileset dir="${resources}">
                <include name="ApplicationServer.properties"/>
            </fileset>
        </copy>
        <unwar src="${war.dir}/distui.war" dest="${jboss_deploy}/distui.war/" overwrite="yes"/>
        <delete dir="${jboss_deploy}/distui.war/META-INF"/>
    </target>


</project>











